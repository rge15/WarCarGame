ASxxxx Assembler V02.00 + NoICE + SDCC mods  (Zilog Z80 / Hitachi HD64180), page 1.
Hexadecimal [16-Bits]



                              1 ;===================================================================================================================================================
                              2 ; CPCTelera functions
                              3 ;===================================================================================================================================================
                              4 .globl cpct_getScreenPtr_asm
                              5 .globl cpct_setVideoMode_asm
                              6 .globl cpct_setPALColour_asm
                              7 .globl cpct_drawSprite_asm
                              8 
                              9 ;===================================================================================================================================================
                             10 ; includes
                             11 ;===================================================================================================================================================
ASxxxx Assembler V02.00 + NoICE + SDCC mods  (Zilog Z80 / Hitachi HD64180), page 2.
Hexadecimal [16-Bits]



                             12 .include "resources/macros.s"
                              1 .globl _macro_addresAux
                              2 
                              3 ;;Cargar el valor de _m_sizeOfEntity
                              4 .macro LOAD_VARIABLE_IN_REGISTER _var, _register
                              5     ld a, (#_var)
                              6     ld _register, a
                              7 .endm 
                              8 
                              9 ;;Cargar crear entidades con el template indicado
                             10 .macro CREATE_ENTITY_FROM_TEMPLATE _template
                             11     ld bc, #_template
                             12     call _m_game_createInitTemplate
                             13 .endm
                             14 
                             15 
                             16 
                             17 ;;;;;;;;;;;;;;;;;;;WORK ON PROGRESS ;;;;;;;;;;;;;;;;;;;;;;
                             18 ;;Carga en el registro A el campo que quieras de la struct de la entity
                             19 ;!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
                             20 ; IMPORTANTE : NO SE PUEDE UTILIZAR EN EL REGISTRO A NI F
                             21 ;!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
                             22 .macro LOAD_ENTITY_VARIABLE_IN_REGISTER _entity, _entity_var, _register
                             23     ; push af
                             24     ; push bc
                             25     ; push hl
                             26     push _entity
                             27     pop ix
                             28     ld _register, _entity_var(ix)
                             29 
                             30     ; ld b,h
                             31     ; ld c,l
                             32     ; ld hl, #_macro_addresAux
                             33     ; ld (hl), c
                             34     ; inc hl
                             35     ; ld (hl), b
                             36 
                             37     ; ld ix, #_macro_addresAux
                             38     ; ld a, _entity_var(ix)
                             39     
                             40     ; pop hl
                             41     ; pop bc
                             42 
                             43     ; ld _register, a
                             44 
                             45     ; pop af
                             46 .endm
                             47 
                             48 ;;Incrementa en 1 la variable indicada de la entidad indicada
                             49 .macro INCREMENT_ENTITY_VARIABLE _entity, _entity_var
                             50     push af
                             51     
                             52     ld _entityAux
                             53     ld ix, _entityAux
                             54     inc _entity_var(ix)
ASxxxx Assembler V02.00 + NoICE + SDCC mods  (Zilog Z80 / Hitachi HD64180), page 3.
Hexadecimal [16-Bits]



                             55 
                             56     pop af
                             57 .endm
                             58 
                             59 ;;Decrementa en 1 la variable indicada de la entidad indicada
                             60 .macro DECREMENT_ENTITY_VARIABLE _entity, _entity_var
                             61     push af
                             62     
                             63 
                             64     ld ix, _entity
                             65     dec _entity_var(ix)
                             66 
                             67     pop af
                             68 .endm
                             69 
                             70 ;;Comprueba si la tecla pasada por parametro se está pulsando
                             71 .macro CHECK_KEYBOARD_INPUT_IN_KEY _key
                             72     call cpct_scanKeyboard_f_asm
                             73     
                             74     ld hl, #_key
                             75     call cpct_isKeyPressed_asm
                             76 .endm 
ASxxxx Assembler V02.00 + NoICE + SDCC mods  (Zilog Z80 / Hitachi HD64180), page 4.
Hexadecimal [16-Bits]



                             13 .include "resources/entityInfo.s"
                              1 ;===================================================================================================================================================
                              2 ; Entity types   
                              3 ;===================================================================================================================================================
                              4 ; #define e_type_invalid     0x00
                              5 ; #define e_type_player      0x01
                              6 ; #define e_type_default     0x02 
                              7 ; #define e_type_dead        0x80
                              8 
                              9 ;===================================================================================================================================================
                             10 ; Component types   
                             11 ;===================================================================================================================================================
                             12 ; #define e_cmp_render   0x01
                             13 ; #define e_cmp_movable  0x02
                             14 ; #define e_cmp_input    0x04
                             15 ; #define e_cmp_ai       0x08
                             16 ; #define e_cmp_animated 0x10
                             17 ; #define e_cmp_collider 0x20
                             18 
                             19 ;===================================================================================================================================================
                             20 ; Entity variables    TODO : MIrar como puedo hacer defines para poder llamar al macro LOAD_ENTITY_VARIABLE_IN_REGISTER
                             21 ;===================================================================================================================================================
                     0000    22 e_type    =  0
                     0001    23 e_cmp     =  1
                     0002    24 e_xpos    =  2
                     0003    25 e_ypos    =  3
                     0004    26 e_width   =  4
                     0005    27 e_heigth  =  5
                     0006    28 e_vx      =  6
                     0007    29 e_vy      =  7
                     0008    30 e_sprite1 =  8
                     0009    31 e_sprite2 =  9
                     000A    32 e_aibeh1  = 10
                     000B    33 e_aibeh2  = 11
                     000C    34 e_anctr   = 12
                     000D    35 e_anim1   = 13
                     000E    36 e_anim2   = 14
                     000F    37 e_animctr = 15
                             38 
                             39 
                             40 
                             41 ;===================================================================================================================================================
                             42 ; Entity struct       TODO : Investigar si así guay la estruct
                             43 ;===================================================================================================================================================
                             44 ; entity:
                             45 ;    .db #0x00                      ; type
                             46 ;    .db #0x00                      ; components
                             47 ;    .db #0x00                      ; x-pos
                             48 ;    .db #0x00                      ; y-pos
                             49 ;    .db #0x00                      ; vx
                             50 ;    .db #0x00                      ; vy
                             51 ;    .db #0x00                      ; width
                             52 ;    .db #0x00                      ; heigth
                             53 ;    .dw #_sprite_spriteExample     ; sprite          
                             54 ;    .dw #_man_anim_animExample     ; animator
ASxxxx Assembler V02.00 + NoICE + SDCC mods  (Zilog Z80 / Hitachi HD64180), page 5.
Hexadecimal [16-Bits]



                             55 ;    .db #0x00                      ; anim. counter
                             56 ;    .dw #_sys_ai_behaviourExample  ; ai_behaviour
                             57 ;    .db #0x00                      ; ai_counter
ASxxxx Assembler V02.00 + NoICE + SDCC mods  (Zilog Z80 / Hitachi HD64180), page 6.
Hexadecimal [16-Bits]



                             14 
                             15 ;===================================================================================================================================================
                             16 ; Public functions
                             17 ;===================================================================================================================================================
                             18 .globl _man_entityForAllMatching
                             19 
                             20 ;===================================================================================================================================================
                             21 ; Public data
                             22 ;===================================================================================================================================================
                             23 .globl _m_functionMemory
                             24 .globl _m_signatureMatch
                             25 
                             26 
                             27 ;===================================================================================================================================================
                             28 ; FUNCION _sys_init_render
                             29 ; Se encarga de iniciar el color y el modo de video de Amstrad(?)
                             30 ; NO llega ningun dato
                             31 ;===================================================================================================================================================
   0000                      32 _sys_init_render::
                             33    ;;Destroyed : HL 
   0000 0E 00         [ 7]   34    ld    c,#0x00
   0002 CD 00 00      [17]   35    call  cpct_setVideoMode_asm
                             36    ;;Destroyed : AF & BC & HL 
   0005 21 10 14      [10]   37    ld hl , #0x1410
   0008 CD 00 00      [17]   38    call  cpct_setPALColour_asm
                             39    ;;Destroyed : F & BC & HL  
                             40 
   000B 21 00 14      [10]   41    ld hl , #0x1400
   000E CD 00 00      [17]   42    call  cpct_setPALColour_asm
                             43    ;;Destroyed : F & BC & HL  
   0011 C9            [10]   44    ret
                             45 
                             46 ;===================================================================================================================================================
                             47 ; FUNCION _sys_render_update
                             48 ; Llama a la inversión de control para renderizar los sprites de cada entidad que coincida con e_type_render
                             49 ; NO llega ningun dato
                             50 ;===================================================================================================================================================
   0012                      51 _sys_render_update::
   0012 21 21 00      [10]   52     ld hl, #_sys_render_renderOneEntity
   0015 22 00 00      [16]   53     ld (_m_functionMemory), hl
   0018 21 00 00      [10]   54     ld hl , #_m_signatureMatch 
   001B 36 01         [10]   55     ld (hl), #0x01   ; e_type_render
   001D CD 00 00      [17]   56     call _man_entityForAllMatching
   0020 C9            [10]   57     ret
                             58 
                             59 
                             60 ;===================================================================================================================================================
                             61 ; FUNCION _sys_render_renderOneEntity
                             62 ; Renderiza los sprites de las entidades renderizables
                             63 ; HL : Entidad a renderizar
                             64 ;===================================================================================================================================================
   0021                      65 _sys_render_renderOneEntity:: ;;TODO : Ver de hacer esto con el reg IX
                             66     ;; Si es una entidad marcada para destruir no se renderiza
   0021 7E            [ 7]   67     ld a, (hl)
   0022 E6 80         [ 7]   68     and #0x80    
ASxxxx Assembler V02.00 + NoICE + SDCC mods  (Zilog Z80 / Hitachi HD64180), page 7.
Hexadecimal [16-Bits]



   0024 20 27         [12]   69     jr NZ, dontRender
                             70 
   0026 E5            [11]   71     push hl
   0027 E5            [11]   72     push hl
                             73     ;; Conseguimos la direccion de memoria donde dibujar con las pos de la entity
   0028 11 00 C0      [10]   74     ld de, #0xC000
                             75 
   002B E5            [11]   76     push hl
   002C DD E1         [14]   77     pop ix
   002E DD 4E 02      [19]   78     ld  c, e_xpos(ix) 
                             79 
   0031 DD 46 03      [19]   80     ld  b, e_ypos(ix) 
                             81     ;LOAD_ENTITY_VARIABLE_IN_REGISTER hl, e_ypos, b
                             82 
                             83     ;LOAD_ENTITY_VARIABLE_IN_REGISTER hl, e_xpos, c
                             84     ;LOAD_ENTITY_VARIABLE_IN_REGISTER hl, e_ypos, b
                             85 
   0034 CD 00 00      [17]   86     call cpct_getScreenPtr_asm
   0037 EB            [ 4]   87     ex de,hl
   0038 E1            [10]   88     pop hl
   0039 D5            [11]   89     push de
                             90     ;; Con la direccion de memoria dibujamos el sprite de la entidad
   003A DD 4E 04      [19]   91     ld  c, e_width(ix) 
   003D DD 46 05      [19]   92     ld  b, e_heigth(ix) 
   0040 DD 56 08      [19]   93     ld  d, e_sprite1(ix) 
   0043 DD 5E 09      [19]   94     ld  e, e_sprite2(ix) 
                             95 
                             96 
                             97     ; LOAD_ENTITY_VARIABLE_IN_REGISTER hl, e_width, c
                             98     
                             99     ; LOAD_ENTITY_VARIABLE_IN_REGISTER hl, e_heigth, b
                            100     
                            101     ; LOAD_ENTITY_VARIABLE_IN_REGISTER hl, e_sprite1, d
                            102     ; LOAD_ENTITY_VARIABLE_IN_REGISTER hl, e_sprite2, e
                            103 
   0046 63            [ 4]  104     ld h,e
   0047 6A            [ 4]  105     ld l,d
   0048 D1            [10]  106     pop de
                            107     
   0049 CD 00 00      [17]  108     call cpct_drawSprite_asm
                            109 
   004C E1            [10]  110     pop hl
   004D                     111     dontRender:
                            112 
   004D C9            [10]  113     ret
